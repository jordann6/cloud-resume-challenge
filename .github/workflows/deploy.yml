name: Deploy to S3

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Configure AWS creds for both S3 sync and CloudFront CLI
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # Sync site to S3 using the AWS CLI
      - name: Sync to S3
        run: |
          aws s3 sync . s3://jordandesigns.io \
            --delete \
            --cache-control "max-age=60,public"

      # Validate the CloudFront distribution ID from the secret
      - name: Validate CloudFront distribution ID
        id: validate
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${DIST_ID:-}" ]; then
            echo "missing=true" >> "$GITHUB_OUTPUT"
            echo "CLOUDFRONT_DISTRIBUTION_ID not set; skipping invalidation."
            exit 0
          fi

          if ! [[ "$DIST_ID" =~ ^E[A-Z0-9]{12,20}$ ]]; then
            echo "Invalid-looking CloudFront ID in secret: $DIST_ID"
            exit 1
          fi

          aws cloudfront get-distribution --id "$DIST_ID" >/dev/null

          echo "missing=false" >> "$GITHUB_OUTPUT"

      # Invalidate CloudFront (wonâ€™t fail deploy if this errors)
      - name: Invalidate CloudFront
        if: steps.validate.outputs.missing == 'false'
        env:
          DIST_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          echo "Creating CloudFront invalidation for $DIST_ID"
          aws cloudfront create-invalidation \
            --distribution-id "$DIST_ID" \
            --paths "/*"
        continue-on-error: true
